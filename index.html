<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoWeather Planner v8.7</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root { --primary-color: #007bff; --primary-hover: #0056b3; --panel-bg: rgba(255, 255, 255, 0.95); --text-color: #212529; --border-color: #dee2e6; }
        html, body { height: 100%; width: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; }
        #map { height: 100%; width: 100%; z-index: 1; background-color: #aacbff; }
        .panel { position: absolute; z-index: 1000; transition: opacity 0.4s ease, transform 0.4s ease; visibility: hidden; opacity: 0; }
        .panel.active { visibility: visible; opacity: 1; }
        
        /* 手機優化的輸入面板 */
        #input-panel { 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 75%; 
            max-width: 300px; 
            max-height: 70vh;
            padding: 16px; 
            background: var(--panel-bg); 
            backdrop-filter: blur(10px); 
            border-radius: 12px; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        #input-panel.active { transform: translate(-50%, -50%) scale(1); }
        
        /* 手機優化的結果面板 */
        #result-panel { 
            bottom: 10px; 
            left: 50%; 
            transform: translateX(-50%) translateY(150%); 
            width: 85%; 
            max-width: 320px; 
            padding: 12px; 
            background: var(--panel-bg); 
            backdrop-filter: blur(10px); 
            border-radius: 12px; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); 
            text-align: center;
            max-height: 40vh;
            overflow-y: auto;
        }
        #result-panel.active { transform: translateX(-50%) translateY(0); }
        
        .result-actions { 
            display: flex; 
            gap: 8px; 
            margin-top: 12px; 
        }
        .result-actions button {
            padding: 8px 12px;
            font-size: 14px;
            flex: 1;
        }
        
        #resultText { line-height: 1.4; font-size: 14px; }
        #resultText h4 { font-size: 1.0em; margin-bottom: 6px;}
        #resultText p { margin: 3px 0; }
        
        /* 天氣面板優化 */
        #weather-panel { 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            background: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            padding: 20px 15px 15px 15px; 
            box-sizing: border-box; 
            transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
            z-index: 2000; 
        }
        #weather-panel.active { transform: translateY(0); }
        
        .panel-header { 
            flex-shrink: 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding-bottom: 10px; 
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color); 
        }
        .panel-content { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding-top: 8px; 
        }
        
        /* 手機版天氣儀表板 */
        .weather-dashboard { 
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }
        .weather-main, .weather-forecast { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        .weather-card { 
            background: #fff; 
            border-radius: 8px; 
            padding: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column;
        }
        .weather-card .weather-title { 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 8px; 
            margin-bottom: 8px; 
            font-size: 14px;
        }
        .weather-card .weather-grid-container { 
            flex-grow: 1; 
            overflow-y: auto; 
        }
        
        h3,h4 { margin: 0; color: var(--text-color); }
        h3 { font-size: 1.3em; }
        h4 { font-size: 1.1em; }
        
        hr { border: 0; border-top: 1px solid var(--border-color); margin: 15px 0; }
        
        label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: #495057; 
            text-align: left;
            font-size: 14px;
        }
        
        input[type="text"] { 
            width: 100%; 
            box-sizing: border-box; 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            font-size: 16px; /* 防止iOS縮放 */
        }
        
        button { 
            width: 100%; 
            padding: 12px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 8px; 
        }
        button:hover { background-color: var(--primary-hover); }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        button i { margin-right: 6px; }
        
        .weather-title { font-weight: bold; font-size: 1.0em; color: var(--primary-color); }
        .weather-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 6px; 
        }
        .weather-item { 
            background: #e9ecef; 
            padding: 6px; 
            border-radius: 4px; 
            line-height: 1.3; 
            text-align: center; 
            font-size: 0.8em; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
        }
        .weather-item .temp-line { font-size: 0.85em; }
        .disclaimer { 
            margin-top: 15px; 
            font-size: 0.75em; 
            color: #6c757d; 
            text-align: center; 
        }
        .rainfall-desc { 
            font-style: italic; 
            color: #495057; 
            display: block; 
            margin-top: 3px; 
            font-size: 0.9em;
        }
        .back-btn { 
            font-size: 1.1em; 
            cursor: pointer; 
            color: var(--primary-color); 
            font-weight: bold; 
        }
        
        /* 手機優化媒體查詢 */
        @media (max-width: 480px) {
            #input-panel {
                width: 80%;
                max-width: none;
                padding: 12px;
            }
            
            #result-panel {
                width: 90%;
                max-width: none;
                padding: 10px;
            }
            
            #weather-panel {
                padding: 25px 12px 12px 12px;
            }
            
            .result-actions {
                flex-direction: column;
                gap: 6px;
            }
            
            .result-actions button {
                font-size: 13px;
                padding: 10px;
            }
            
            #resultText {
                font-size: 13px;
            }
            
            .weather-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 4px;
            }
            
            .weather-item {
                padding: 4px;
                font-size: 0.75em;
            }
            
            .weather-card {
                padding: 10px;
            }
            
            h3 { font-size: 1.2em; }
            h4 { font-size: 1.0em; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="input-panel" class="panel active">
        <h3>GeoWeather Planner</h3>
        <label for="addressInput"><i class="wi wi-search"></i> 地址查詢</label>
        <input type="text" id="addressInput" placeholder="地點名稱，例如：玉山主峰">
        <input type="text" id="regionInput" placeholder="地區/縣市 (選填，可增加準確度)" style="margin-top: 5px;">
        <button id="geocode-btn">查詢</button>
        <hr>
        <label for="latInput"><i class="wi wi-geo-alt"></i> 座標查詢</label>
        <input type="text" id="latInput" placeholder="緯度 (Latitude)">
        <input type="text" id="lngInput" placeholder="經度 (Longitude)" style="margin-top: 5px;">
        <button id="plot-btn">標定</button>
    </div>
    <div id="result-panel" class="panel">
        <div id="resultText"></div>
        <div class="result-actions">
            <button id="new-search-btn" class="secondary"><i class="wi wi-refresh"></i> 重新查詢</button>
            <button id="show-weather-btn"><i class="wi wi-day-cloudy"></i> 檢視天氣預報</button>
        </div>
    </div>
    <div id="weather-panel" class="panel">
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('map').setView([23.9738, 120.982], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            const inputPanel = document.getElementById('input-panel');
            const resultPanel = document.getElementById('result-panel');
            const weatherPanel = document.getElementById('weather-panel');
            const resultText = document.getElementById('resultText');
            let marker, currentCoords = null;

            function showInputView() { resultPanel.classList.remove('active'); weatherPanel.classList.remove('active'); inputPanel.classList.add('active'); if (marker) { marker.remove(); marker = null; } }
            function showResultView() { inputPanel.classList.remove('active'); weatherPanel.classList.remove('active'); resultPanel.classList.add('active'); }
            function showWeatherView() { resultPanel.classList.remove('active'); weatherPanel.classList.add('active'); }
            async function getElevation(lat, lng) { try { const r = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lng}`); const d = await r.json(); return d?.elevation?.[0] ?? null; } catch (e) { return null; } }
            async function getWeatherData(lat, lng) { const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,apparent_temperature,precipitation_probability,precipitation&daily=temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,precipitation_probability_max&current=temperature_2m,apparent_temperature,precipitation,precipitation_probability&past_days=2&forecast_days=16&timezone=auto`; try { const r = await fetch(url); return await r.json(); } catch (e) { return null; } }
            function getRainfallInfo(mm) { if (typeof mm !== 'number' || isNaN(mm)) return { desc: '資料異常', icon: 'wi-na' }; if (mm <= 0) return { desc: '無雨', icon: 'wi-day-sunny' }; if (mm < 2.5) return { desc: '毛毛雨', icon: 'wi-sprinkle' }; if (mm < 15) return { desc: '小雨', icon: 'wi-rain' }; if (mm < 50) return { desc: '大雨', icon: 'wi-showers' }; if (mm < 100) return { desc: '豪雨', icon: 'wi-rain-wind' }; return { desc: '大豪雨', icon: 'wi-thunderstorm' }; }
            function getAccumulatedRainfallDescription(mm) { if (mm < 20) return "影響輕微，但步道上的青苔石塊仍可能濕滑。"; if (mm < 80) return "相當於一場持續數小時的雷陣雨，土質已鬆軟。"; if (mm < 200) return "雨量驚人，如同高速公路暴雨。邊坡含水量極高。"; return "致災性雨量！溪水可能暴漲，土石流風險劇增。"; }
            function getTemperatureIcon(temp) { if (temp > 32) return `<i class="wi wi-hot" style="color: #e63946;" title="酷熱"></i>`; if (temp > 25) return `<i class="wi wi-thermometer" style="color: #f4a261;" title="溫暖"></i>`; if (temp < 10) return `<i class="wi wi-snowflake-cold" style="color: #0077b6;" title="寒冷"></i>`; if (temp < 18) return `<i class="wi wi-thermometer-exterior" style="color: #2a9d8f;" title="涼爽"></i>`; return `<i class="wi wi-thermometer" title="舒適"></i>`; }
            function formatWeatherInfo(data) {
                let html = `<div class="panel-header"><h4>${getTemperatureIcon(data.current.temperature_2m)} 天氣報告</h4><span class="back-btn" id="back-from-weather-dynamic">&larr; 返回</span></div><div class="panel-content"><div class="weather-dashboard">`;
                const past48hPrecipitation = data.hourly.precipitation.slice(0, 48).reduce((a, b) => a + b, 0);
                html += `<div class="weather-main"><div class="weather-card"><div class="weather-title">過去48小時 (安全參考)</div><p>累積雨量: <b>${past48hPrecipitation.toFixed(1)} mm</b><br><span class="rainfall-desc">${getAccumulatedRainfallDescription(past48hPrecipitation)}</span></p></div><div class="weather-card"><div class="weather-title">目前狀況</div><p style="font-size: 1.1em;">${getTemperatureIcon(data.current.temperature_2m)} ${data.current.temperature_2m}°C <small>(體感 ${data.current.apparent_temperature}°C)</small></p><p><i class="wi ${getRainfallInfo(data.current.precipitation).icon}"></i> ${getRainfallInfo(data.current.precipitation).desc}</p></div></div>`;
                html += `<div class="weather-forecast"><div class="weather-card"><div class="weather-title">未來 16 天預報 <small>(低溫 / 高溫)</small></div><div class="weather-grid-container"><div class="weather-grid">`;
                const todayStr = new Date().toISOString().split('T')[0];
                let daysShown = 0;
                data.daily.time.forEach((day, i) => {
                    if (day > todayStr && daysShown < 15) {
                        const forecastDate = new Date(day);
                        const minTemp = data.daily.temperature_2m_min[i];
                        const maxTemp = data.daily.temperature_2m_max[i];
                        const rainProb = data.daily.precipitation_probability_max[i];
                        html += `<div class="weather-item"><b>${forecastDate.getMonth()+1}/${forecastDate.getDate()}</b><div class="temp-line">${getTemperatureIcon(minTemp)} ${minTemp}° / ${getTemperatureIcon(maxTemp)} ${maxTemp}°</div><div class="temp-line"><i class="wi wi-umbrella"></i> ${rainProb}%</div></div>`;
                        daysShown++;
                    }
                });
                html += `</div></div></div>`;
                html += `<div class="disclaimer">資料來源: Open-Meteo.com | 圖示: Weather Icons<br>天氣預報僅供參考，請以中央氣象署及實地現況為準，並做好萬全準備。</div></div></div>`;
                return html;
            }
            async function processNewLocation(lat, lng, title, baseDetails) { if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) { alert("收到的座標無效"); return; } currentCoords = { lat, lng }; map.flyTo([lat, lng], 14); if (marker) marker.setLatLng([lat, lng]); else marker = L.marker([lat, lng]).addTo(map); showResultView(); resultText.innerHTML = `<h4>${title}</h4><p>${baseDetails}</p><hr>海拔: 查詢中...`; const e = await getElevation(lat, lng); const t = e !== null ? `<b>海拔:</b> ${e.toFixed(2)} 公尺` : '<b>海拔:</b> 查詢失敗'; const c = `<h4>${title}</h4><p>${baseDetails}</p><hr>${t}`; resultText.innerHTML = c; marker.bindPopup(c, {offset: [0, -15]}).openPopup(); }
            
            document.getElementById('show-weather-btn').addEventListener('click', async () => { if (!currentCoords) return; showWeatherView(); weatherPanel.innerHTML = '<div style="text-align:center; padding: 20px;"><h3><i class="wi wi-cloud-refresh"></i> 正在載入天氣資料...</h3></div>'; const d = await getWeatherData(currentCoords.lat, currentCoords.lng); if (d && !d.error) { weatherPanel.innerHTML = formatWeatherInfo(d); document.getElementById('back-from-weather-dynamic').addEventListener('click', showResultView); } else { weatherPanel.innerHTML = `<div class="panel-header"><h4>天氣資料載入失敗</h4><span class="back-btn" onclick="showResultView()">&larr; 返回</span></div><div class="panel-content"><p>${d?.reason||'請檢查網路連線'}</p></div>`; } });
            document.getElementById('new-search-btn').addEventListener('click', showInputView);
            map.on('click', async (e) => { const { lat, lng } = e.latlng; document.getElementById('latInput').value = lat.toFixed(6); document.getElementById('lngInput').value = lng.toFixed(6); await processNewLocation(lat, lng, "地圖點選位置", `緯度: ${lat.toFixed(6)}<br>經度: ${lng.toFixed(6)}`); });
            async function geocodeAddress() { const address = document.getElementById('addressInput').value; const region = document.getElementById('regionInput').value; if (!address) { alert('請輸入地點名稱'); return; } const fullQuery = region ? `${address} ${region}` : address; const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullQuery)}`; try { const r = await fetch(url); const d = await r.json(); if (d && d.length > 0 && d[0].lat && d[0].lon) { const lat = parseFloat(d[0].lat); const lng = parseFloat(d[0].lon); document.getElementById('latInput').value = lat.toFixed(6); document.getElementById('lngInput').value = lng.toFixed(6); await processNewLocation(lat, lng, "地址查詢結果", `<i>${d[0].display_name}</i>`); } else { alert(`錯誤：找不到「${fullQuery}」。`); } } catch (e) { console.error('Geocoding error:', e); alert('錯誤：地址查詢時發生問題。'); } }
            document.getElementById('geocode-btn').addEventListener('click', geocodeAddress);
            async function plotCoordinates() { const lat = parseFloat(document.getElementById('latInput').value); const lng = parseFloat(document.getElementById('lngInput').value); await processNewLocation(lat, lng, "座標位置", `緯度: ${lat.toFixed(6)}<br>經度: ${lng.toFixed(6)}`); }
            document.getElementById('plot-btn').addEventListener('click', plotCoordinates);

            showInputView();
        });
    </script>
</body>
</html>
